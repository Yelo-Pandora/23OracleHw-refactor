<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2.8.4 åœè½¦åœºå†…è½¦è¾†çŠ¶æ€æŸ¥è¯¢ - æµ‹è¯•é¡µé¢</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 15px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .header { 
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white; 
      padding: 30px; 
      text-align: center; 
    }
    .header h1 { font-size: 28px; margin-bottom: 10px; }
    .header p { font-size: 16px; opacity: 0.9; }
    .content { padding: 30px; }
    .card { 
      background: #f8f9fa; 
      border-radius: 10px; 
      padding: 25px; 
      margin-bottom: 25px; 
      border-left: 4px solid #4CAF50;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .card h3 { 
      color: #333; 
      margin-bottom: 20px; 
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card h3::before {
      content: "ğŸš—";
      font-size: 24px;
    }
    .form-group { 
      margin-bottom: 20px; 
    }
    .form-group label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: bold; 
      color: #555;
    }
    .form-group input, .form-group select { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #ddd; 
      border-radius: 8px; 
      font-size: 16px;
      transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group select:focus { 
      outline: none; 
      border-color: #4CAF50; 
    }
    .btn { 
      background: #4CAF50; 
      color: white; 
      border: none; 
      padding: 12px 24px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 16px;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .btn:hover { 
      background: #45a049; 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }
    .btn.secondary { 
      background: #2196F3; 
    }
    .btn.secondary:hover { 
      background: #1976D2; 
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }
    .btn.warning { 
      background: #FF9800; 
    }
    .btn.warning:hover { 
      background: #F57C00; 
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
    }
    .btn.danger { 
      background: #f44336; 
    }
    .btn.danger:hover { 
      background: #d32f2f; 
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .log { 
      background: #1e1e1e; 
      color: #00ff00; 
      padding: 20px; 
      border-radius: 8px; 
      font-family: 'Consolas', monospace; 
      font-size: 14px; 
      max-height: 400px; 
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .badge { 
      padding: 4px 12px; 
      border-radius: 20px; 
      font-size: 12px; 
      font-weight: bold;
    }
    .badge.active { 
      background: #4CAF50; 
      color: white; 
    }
    .badge.info { 
      background: #2196F3; 
      color: white; 
    }
    .badge.warning { 
      background: #FF9800; 
      color: white; 
    }
    .badge.error { 
      background: #f44336; 
      color: white; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 15px;
    }
    th, td { 
      padding: 12px; 
      text-align: left; 
      border: 1px solid #ddd;
    }
    th { 
      background: #f5f5f5; 
      font-weight: bold;
      color: #333;
    }
    tr:nth-child(even) { 
      background: #f9f9f9; 
    }
    tr:hover { 
      background: #e8f5e9; 
    }
    .search-result {
      background: #e8f5e9;
      border: 2px solid #4CAF50;
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
    }
    .search-result h4 {
      color: #2e7d32;
      margin-bottom: 15px;
      font-size: 18px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .info-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    .info-item label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
      display: block;
    }
    .info-item .value {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    .no-result {
      background: #fff3cd;
      border: 2px solid #ffc107;
      color: #856404;
      padding: 20px;
      border-radius: 10px;
      margin-top: 15px;
      text-align: center;
    }
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }
    .alert.success {
      background: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border-color: #ffeaa7;
    }
    .alert.info {
      background: #d1ecf1;
      color: #0c5460;
      border-color: #bee5eb;
    }
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      border: 2px solid #e9ecef;
    }
    .stat-card.primary {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    .stat-card.info {
      border-color: #2196F3;
      background: #e3f2fd;
    }
    .stat-card.warning {
      border-color: #FF9800;
      background: #fff3e0;
    }
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 0.9em;
      color: #666;
    }
    .auto-refresh {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .auto-refresh input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    .loading {
      text-align: center;
      padding: 40px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .json-display {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸš— åœè½¦åœºå†…è½¦è¾†çŠ¶æ€æŸ¥è¯¢</h1>
    <p>2.8.4 åŠŸèƒ½æµ‹è¯• - ç®¡ç†å‘˜é€‰æ‹©åœè½¦åœºæŸ¥çœ‹åœ¨åœè½¦è¾† & è½¦ç‰Œå·æŸ¥è¯¢</p>
  </div>

  <div class="content">
    <!-- åŠŸèƒ½è¯´æ˜ -->
    <div class="card" style="background: #e3f2fd; border-left-color: #2196f3;">
      <h3 style="color: #1976d2;">ğŸ¯ åŠŸèƒ½2.8.4è¯´æ˜</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
        <div>
          <strong>ä¸»è¦åŠŸèƒ½:</strong><br>
          â€¢ è·å–åœè½¦åœºåˆ—è¡¨ (GET /ParkingLots)<br>
          â€¢ æŸ¥è¯¢åœ¨åœè½¦è¾† (GET /CurrentVehicles)<br>
          â€¢ è½¦ç‰Œå·æŸ¥è¯¢è½¦è¾†çŠ¶æ€ (GET /VehicleStatus/{licensePlate})<br>
          â€¢ æ”¯æŒæŒ‰åœè½¦åœºç­›é€‰æŸ¥è¯¢
        </div>
        <div>
          <strong>æƒé™è¦æ±‚:</strong><br>
          â€¢ åŒ¿åè®¿é—®: å¯æŸ¥è¯¢<br>
          â€¢ å‘˜å·¥æƒé™: å¯æŸ¥è¯¢<br>
          â€¢ ç®¡ç†å‘˜æƒé™: å¯æŸ¥è¯¢<br>
          â€¢ éœ€è¦æƒé™çº§åˆ« â‰¤ 3
        </div>
      </div>
    </div>

    <!-- APIè¿æ¥æµ‹è¯• -->
    <div class="card">
      <h3>ğŸ”Œ APIè¿æ¥æµ‹è¯•</h3>
      <div class="form-group">
        <label>ğŸŒ APIæœåŠ¡åœ°å€</label>
        <input id="apiBaseUrl" value="http://localhost:5263/api/Parking" placeholder="è¯·è¾“å…¥APIæœåŠ¡åœ°å€" />
      </div>
      <div class="form-group">
        <label>ğŸ‘¤ æ“ä½œå‘˜è´¦å·</label>
        <select id="operatorAccount">
          <option value="">-- è¯·é€‰æ‹©æ“ä½œå‘˜è´¦å· --</option>
          <option value="admin_test">admin_test (ç®¡ç†å‘˜æµ‹è¯•)</option>
          <option value="manager_test">manager_test (ç»ç†æµ‹è¯•)</option>
          <option value="staff_test">staff_test (å‘˜å·¥æµ‹è¯•)</option>
          <option value="invalid_user">invalid_user (æ— æ•ˆç”¨æˆ·)</option>
        </select>
      </div>
      <div style="margin-bottom: 20px;">
        <button class="btn secondary" onclick="testApiConnection()">ğŸ” æµ‹è¯•APIè¿æ¥</button>
        <button class="btn" onclick="loadParkingLots()">ğŸ”„ åˆ·æ–°åœè½¦åœºåˆ—è¡¨</button>
      </div>
      <div id="apiTestResult"></div>
    </div>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div class="card">
      <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
      <div class="stats-panel" id="statsPanel">
        <div class="stat-card primary">
          <div class="stat-number" id="totalParkingLots">-</div>
          <div class="stat-label">åœè½¦åœºæ€»æ•°</div>
        </div>
        <div class="stat-card info">
          <div class="stat-number" id="totalVehicles">-</div>
          <div class="stat-label">åœ¨åœè½¦è¾†æ€»æ•°</div>
        </div>
        <div class="stat-card warning">
          <div class="stat-number" id="selectedAreaVehicles">-</div>
          <div class="stat-label">é€‰ä¸­åŒºåŸŸè½¦è¾†</div>
        </div>
      </div>
    </div>

    <!-- åœè½¦åœºé€‰æ‹© -->
    <div class="card">
      <h3>ğŸ¢ åœè½¦åœºé€‰æ‹©</h3>
      <div class="form-group">
        <label>é€‰æ‹©åœè½¦åœº</label>
        <select id="parkingLotSelect" onchange="onParkingLotChange()">
          <option value="">è¯·é€‰æ‹©åœè½¦åœº...</option>
        </select>
      </div>
      <div class="auto-refresh">
        <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
        <label for="autoRefresh">ğŸ”„ è‡ªåŠ¨åˆ·æ–° (10ç§’)</label>
      </div>
      <div style="margin-bottom: 20px;">
        <button class="btn" onclick="loadAllCurrentVehicles()">ğŸš— æŸ¥çœ‹æ‰€æœ‰åœ¨åœè½¦è¾†</button>
        <button class="btn secondary" onclick="refreshCurrentData()">ğŸ”„ åˆ·æ–°å½“å‰æ•°æ®</button>
        <button class="btn warning" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
      </div>
    </div>

    <!-- åœ¨åœè½¦è¾†åˆ—è¡¨ -->
    <div class="card">
      <h3>ğŸš™ åœ¨åœè½¦è¾†ä¿¡æ¯</h3>
      <div id="currentVehicles"></div>
    </div>

    <!-- è½¦ç‰Œå·æŸ¥è¯¢ -->
    <div class="card">
      <h3>ğŸ” è½¦ç‰Œå·æŸ¥è¯¢</h3>
      <div class="form-group">
        <label>è½¦ç‰Œå·</label>
        <input id="licensePlateQuery" placeholder="è¯·è¾“å…¥è½¦ç‰Œå·ï¼Œå¦‚ï¼šTEST001" maxlength="20" />
      </div>
      <div style="margin-bottom: 20px;">
        <button class="btn" onclick="queryVehicleStatus()">ğŸ” æŸ¥è¯¢è½¦è¾†çŠ¶æ€</button>
        <button class="btn secondary" onclick="clearQuery()">ğŸ§¹ æ¸…ç©ºæŸ¥è¯¢</button>
        <button class="btn warning" onclick="quickTest()">âš¡ å¿«é€Ÿæµ‹è¯•</button>
      </div>
      <div id="vehicleStatusResult"></div>
    </div>

    <!-- è°ƒè¯•è¾“å‡º -->
    <div class="card">
      <h3>ğŸ“ è°ƒè¯•è¾“å‡º</h3>
      <div id="log" class="log"></div>
    </div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let autoRefreshInterval = null;
let currentVehiclesData = []; // å½“å‰æ˜¾ç¤ºçš„è½¦è¾†æ•°æ®
let allVehiclesData = []; // æ‰€æœ‰åœè½¦åœºçš„è½¦è¾†æ•°æ®
let parkingLotsData = [];

// å·¥å…·å‡½æ•°
function el(id) { return document.getElementById(id); }
function api() { return el('apiBaseUrl').value.trim() || 'http://localhost:5263/api/Parking'; }
function getOperatorAccount() { return el('operatorAccount').value; }

function log(...args) { 
  const timestamp = new Date().toLocaleTimeString();
  el('log').textContent += `[${timestamp}] ${args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' ')}\n`;
  el('log').scrollTop = el('log').scrollHeight;
}

function clearLog() { el('log').textContent = ''; }

function showAlert(message, type = 'info') {
  const alertClass = type === 'error' ? 'alert error' : 
                    type === 'success' ? 'alert success' : 
                    type === 'warning' ? 'alert warning' : 'alert info';
  
  const alertDiv = document.createElement('div');
  alertDiv.className = alertClass;
  alertDiv.innerHTML = message;
  
  const container = el('apiTestResult');
  container.innerHTML = '';
  container.appendChild(alertDiv);
  
  // 3ç§’åè‡ªåŠ¨éšè—
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.parentNode.removeChild(alertDiv);
    }
  }, 3000);
}

function showLoading(containerId) {
  document.getElementById(containerId).innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
    </div>
  `;
}

// APIè¿æ¥æµ‹è¯•
async function testApiConnection() {
  const testButton = event.target;
  const originalText = testButton.textContent;
  
  testButton.textContent = 'æµ‹è¯•ä¸­...';
  testButton.disabled = true;
  
  try {
    const apiUrl = api();
    const testUrl = `${apiUrl}/ParkingLots`;
    
    log('æµ‹è¯•APIè¿æ¥:', testUrl);
    
    const response = await fetch(testUrl, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      showAlert('âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸï¼åœè½¦åœºæœåŠ¡å¯ç”¨', 'success');
      log('APIè¿æ¥æµ‹è¯•æˆåŠŸï¼ŒçŠ¶æ€ç :', response.status);
    } else {
      showAlert(`âŒ APIè¿æ¥å¤±è´¥ï¼çŠ¶æ€ç : ${response.status}`, 'error');
      log('APIè¿æ¥å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
    }
  } catch (error) {
    showAlert(`âŒ APIè¿æ¥å¼‚å¸¸ï¼${error.message}`, 'error');
    log('APIè¿æ¥å¼‚å¸¸:', error);
  } finally {
    testButton.textContent = originalText;
    testButton.disabled = false;
  }
}

// åŠ è½½åœè½¦åœºåˆ—è¡¨
async function loadParkingLots(){
  showLoading('apiTestResult');
  const url = api() + '/ParkingLots';
  const operatorAccount = getOperatorAccount();
  const fullUrl = operatorAccount ? `${url}?operatorAccount=${encodeURIComponent(operatorAccount)}` : url;
  
  try{
    const resp = await fetch(fullUrl);
    const data = await resp.json();
    log('ParkingLots è¯·æ±‚', fullUrl);
    log('ParkingLots å“åº”', resp.status, resp.statusText, data);
    
    if(resp.ok && data && data.Data){
      parkingLotsData = data.Data;
      populateParkingLotSelect(data.Data);
      updateStats();
      showAlert(`âœ… æˆåŠŸè·å–${data.Data.length}ä¸ªåœè½¦åœºä¿¡æ¯`, 'success');
    } else {
      showAlert(`âŒ è·å–åœè½¦åœºåˆ—è¡¨å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
    }
  }catch(e){ 
    showAlert(`âŒ ç½‘ç»œé”™è¯¯: ${e.message}`, 'error');
    log('ParkingLots å¼‚å¸¸', e.name, e.message); 
  }
}

// å¡«å……åœè½¦åœºä¸‹æ‹‰åˆ—è¡¨
function populateParkingLotSelect(parkingLots){
  const select = el('parkingLotSelect');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©åœè½¦åœº...</option>';
  
  parkingLots.forEach(lot => {
    const option = document.createElement('option');
    option.value = lot.AreaId;
    option.textContent = `${lot.ParkingLotName} (${lot.ParkingFee}å…ƒ/å°æ—¶)`;
    select.appendChild(option);
  });
}

// åœè½¦åœºé€‰æ‹©å˜åŒ–äº‹ä»¶
function onParkingLotChange(){
  const areaId = el('parkingLotSelect').value;
  if(areaId){
    loadCurrentVehiclesByParkingLot(areaId);
  } else {
    el('currentVehicles').innerHTML = '';
    updateStats();
  }
}

// åŠ è½½æŒ‡å®šåœè½¦åœºçš„åœ¨åœè½¦è¾†
async function loadCurrentVehiclesByParkingLot(areaId){
  showLoading('currentVehicles');
  const url = api() + '/CurrentVehicles';
  const operatorAccount = getOperatorAccount();
  const fullUrl = `${url}?areaId=${areaId}${operatorAccount ? '&operatorAccount=' + encodeURIComponent(operatorAccount) : ''}`;
  
  try{
    const resp = await fetch(fullUrl);
    const data = await resp.json();
    log('CurrentVehicles è¯·æ±‚', fullUrl);
    log('CurrentVehicles å“åº”', resp.status, resp.statusText, data);
    
    if(resp.ok && data){
      currentVehiclesData = data.Data || [];
      displayCurrentVehicles(data.Data || [], data.Message);
      updateStats();
    } else {
      showAlert(`âŒ è·å–åœ¨åœè½¦è¾†å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
    }
  }catch(e){ 
    showAlert(`âŒ ç½‘ç»œé”™è¯¯: ${e.message}`, 'error');
    log('CurrentVehicles å¼‚å¸¸', e.name, e.message); 
  }
}

// åŠ è½½æ‰€æœ‰åœ¨åœè½¦è¾†ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
async function loadAllCurrentVehicles(){
  showLoading('currentVehicles');
  const url = api() + '/CurrentVehicles';
  const operatorAccount = getOperatorAccount();
  const fullUrl = operatorAccount ? `${url}?operatorAccount=${encodeURIComponent(operatorAccount)}` : url;
  
  try{
    const resp = await fetch(fullUrl);
    const data = await resp.json();
    log('AllCurrentVehicles è¯·æ±‚', fullUrl);
    log('AllCurrentVehicles å“åº”', resp.status, resp.statusText, data);
    
    if(resp.ok && data){
      allVehiclesData = data.Data || [];
      currentVehiclesData = data.Data || [];
      displayCurrentVehicles(data.Data || [], data.Message);
      // æ¸…ç©ºåœè½¦åœºé€‰æ‹©
      el('parkingLotSelect').value = '';
      updateStats();
    } else {
      showAlert(`âŒ è·å–æ‰€æœ‰åœ¨åœè½¦è¾†å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
    }
  }catch(e){ 
    showAlert(`âŒ ç½‘ç»œé”™è¯¯: ${e.message}`, 'error');
    log('AllCurrentVehicles å¼‚å¸¸', e.name, e.message); 
  }
}

// åŠ è½½æ‰€æœ‰åœ¨åœè½¦è¾†ï¼ˆä»…ç”¨äºç»Ÿè®¡ï¼Œä¸æ˜¾ç¤ºï¼‰
async function loadAllVehiclesForStats(){
  const url = api() + '/CurrentVehicles';
  const operatorAccount = getOperatorAccount();
  const fullUrl = operatorAccount ? `${url}?operatorAccount=${encodeURIComponent(operatorAccount)}` : url;
  
  try{
    const resp = await fetch(fullUrl);
    const data = await resp.json();
    log('LoadAllVehiclesForStats è¯·æ±‚', fullUrl);
    
    if(resp.ok && data){
      allVehiclesData = data.Data || [];
      updateStats();
      log('ç»Ÿè®¡æ•°æ®æ›´æ–°å®Œæˆï¼Œæ€»è½¦è¾†æ•°:', allVehiclesData.length);
    }
  }catch(e){ 
    log('LoadAllVehiclesForStats å¼‚å¸¸', e.name, e.message); 
  }
}

// æ˜¾ç¤ºåœ¨åœè½¦è¾†åˆ—è¡¨
function displayCurrentVehicles(vehicles, message){
  const container = el('currentVehicles');
  
  if(!vehicles || vehicles.length === 0){
    container.innerHTML = `<div class="no-result">
      <h4>ğŸ“­ ${message || 'å½“å‰åœè½¦åœºæ— åœ¨åœè½¦è¾†'}</h4>
      <p>æ‰€æœ‰è½¦ä½éƒ½æ˜¯ç©ºé—²çŠ¶æ€</p>
    </div>`;
    return;
  }
  
  let html = `<div style="margin-bottom: 15px;">
    <span class="badge info">å…± ${vehicles.length} è¾†åœ¨åœè½¦è¾†</span>
    <span class="badge active">æœ€åæ›´æ–°: ${new Date().toLocaleString()}</span>
  </div>`;
  
  html += '<table>';
  html += '<tr><th>è½¦ç‰Œå·</th><th>è½¦ä½ID</th><th>åŒºåŸŸ</th><th>åœè½¦åœº</th><th>å…¥åœºæ—¶é—´</th><th>å½“å‰æ—¶é•¿</th><th>çŠ¶æ€</th></tr>';
  
  vehicles.forEach(vehicle => {
    const parkStart = new Date(vehicle.ParkStart).toLocaleString('zh-CN');
    const duration = formatDuration(vehicle.CurrentDuration);
    
    html += `<tr>
      <td><strong>${vehicle.LicensePlateNumber}</strong></td>
      <td>${vehicle.ParkingSpaceId}</td>
      <td>${vehicle.AreaName}</td>
      <td>${vehicle.ParkingLotName}</td>
      <td>${parkStart}</td>
      <td>${duration}</td>
      <td><span class="badge active">${vehicle.Status}</span></td>
    </tr>`;
  });
  
  html += '</table>';
  container.innerHTML = html;
}

// æŸ¥è¯¢è½¦è¾†çŠ¶æ€
async function queryVehicleStatus(){
  const licensePlate = el('licensePlateQuery').value.trim();
  
  if(!licensePlate){
    showAlert('è¯·è¾“å…¥è½¦ç‰Œå·', 'warning');
    return;
  }
  
  const url = api() + '/VehicleStatus/' + encodeURIComponent(licensePlate);
  const operatorAccount = getOperatorAccount();
  const fullUrl = operatorAccount ? `${url}?operatorAccount=${encodeURIComponent(operatorAccount)}` : url;
  
  try{
    const resp = await fetch(fullUrl);
    const data = await resp.json();
    log('VehicleStatus è¯·æ±‚', fullUrl);
    log('VehicleStatus å“åº”', resp.status, resp.statusText, data);
    
    if(resp.ok && data){
      displayVehicleStatus(data.Data, data.Message, data.Success);
    } else {
      showAlert(`âŒ æŸ¥è¯¢è½¦è¾†çŠ¶æ€å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
    }
  }catch(e){ 
    showAlert(`âŒ ç½‘ç»œé”™è¯¯: ${e.message}`, 'error');
    log('VehicleStatus å¼‚å¸¸', e.name, e.message); 
  }
}

// æ˜¾ç¤ºè½¦è¾†çŠ¶æ€æŸ¥è¯¢ç»“æœ
function displayVehicleStatus(vehicle, message, success){
  const container = el('vehicleStatusResult');
  
  if(!success || !vehicle){
    container.innerHTML = `<div class="no-result">
      <h4>âŒ ${message || 'æœªæŸ¥è¯¢åˆ°è¯¥è½¦ç‰Œå·çš„åœ¨åœè®°å½•'}</h4>
      <p>è¯·æ£€æŸ¥è½¦ç‰Œå·æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è¯¥è½¦è¾†æ˜¯å¦å·²ç¦»åœº</p>
    </div>`;
    return;
  }
  
  const parkStart = new Date(vehicle.ParkStart).toLocaleString('zh-CN');
  const duration = formatDuration(vehicle.CurrentDuration);
  
  container.innerHTML = `<div class="search-result">
    <h4>âœ… æŸ¥è¯¢æˆåŠŸ - ${vehicle.LicensePlateNumber}</h4>
    <div class="info-grid">
      <div class="info-item">
        <label>è½¦ç‰Œå·</label>
        <div class="value">${vehicle.LicensePlateNumber}</div>
      </div>
      <div class="info-item">
        <label>è½¦ä½ID</label>
        <div class="value">${vehicle.ParkingSpaceId}</div>
      </div>
      <div class="info-item">
        <label>åœè½¦åœº</label>
        <div class="value">${vehicle.ParkingLotName}</div>
      </div>
      <div class="info-item">
        <label>åŒºåŸŸ</label>
        <div class="value">${vehicle.AreaName}</div>
      </div>
      <div class="info-item">
        <label>å…¥åœºæ—¶é—´</label>
        <div class="value">${parkStart}</div>
      </div>
      <div class="info-item">
        <label>å½“å‰æ—¶é•¿</label>
        <div class="value">${duration}</div>
      </div>
      <div class="info-item">
        <label>è½¦è¾†çŠ¶æ€</label>
        <div class="value"><span class="badge active">${vehicle.Status}</span></div>
      </div>
    </div>
  </div>`;
}

// æ¸…ç©ºæŸ¥è¯¢
function clearQuery(){
  el('licensePlateQuery').value = '';
  el('vehicleStatusResult').innerHTML = '';
}

// åˆ·æ–°å½“å‰æ•°æ®
function refreshCurrentData() {
  const areaId = el('parkingLotSelect').value;
  if (areaId) {
    loadCurrentVehiclesByParkingLot(areaId);
  } else {
    loadAllCurrentVehicles();
  }
  // åŒæ—¶æ›´æ–°ç»Ÿè®¡æ•°æ®
  loadAllVehiclesForStats();
}

// åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
function toggleAutoRefresh() {
  const checkbox = el('autoRefresh');
  
  if (checkbox.checked) {
    autoRefreshInterval = setInterval(() => {
      refreshCurrentData();
    }, 10000);
    showAlert('ğŸ”„ å·²å¼€å¯è‡ªåŠ¨åˆ·æ–° (æ¯10ç§’)', 'success');
  } else {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
    showAlert('â¹ï¸ å·²å…³é—­è‡ªåŠ¨åˆ·æ–°', 'warning');
  }
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats() {
  el('totalParkingLots').textContent = parkingLotsData.length;
  el('totalVehicles').textContent = allVehiclesData.length;
  
  const selectedAreaId = el('parkingLotSelect').value;
  if (selectedAreaId) {
    const areaVehicles = currentVehiclesData.filter(v => v.AreaId == selectedAreaId);
    el('selectedAreaVehicles').textContent = areaVehicles.length;
  } else {
    el('selectedAreaVehicles').textContent = '-';
  }
}

// æ ¼å¼åŒ–æ—¶é•¿
function formatDuration(duration){
  if(!duration) return '0åˆ†é’Ÿ';
  
  // è§£æ C# TimeSpan æ ¼å¼ (å¦‚: "1.02:30:45" æˆ– "02:30:45")
  const match = duration.match(/(?:(\d+)\.)?(\d+):(\d+):(\d+)/);
  if(match){
    const days = parseInt(match[1] || '0');
    const hours = parseInt(match[2]);
    const minutes = parseInt(match[3]);
    const seconds = parseInt(match[4]);
    
    let result = '';
    if(days > 0) result += `${days}å¤©`;
    if(hours > 0) result += `${hours}å°æ—¶`;
    if(minutes > 0) result += `${minutes}åˆ†é’Ÿ`;
    if(result === '' && seconds > 0) result = `${seconds}ç§’`;
    
    return result || 'åˆšå…¥åœº';
  }
  
  return duration;
}

// å¿«é€Ÿæµ‹è¯•æŒ‰é’®
function quickTest(){
  const testPlates = ['TEST001', 'TEST002', 'TEST003', 'STATUS001', 'STATUS002', 'STATUS003'];
  const randomPlate = testPlates[Math.floor(Math.random() * testPlates.length)];
  el('licensePlateQuery').value = randomPlate;
  queryVehicleStatus();
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½åœè½¦åœºåˆ—è¡¨
window.onload = function(){
  loadParkingLots();
  // å»¶è¿ŸåŠ è½½æ‰€æœ‰è½¦è¾†æ•°æ®ï¼Œç¡®ä¿ç»Ÿè®¡å‡†ç¡®
  setTimeout(() => {
    loadAllVehiclesForStats();
  }, 1000);
  log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æµ‹è¯• 2.8.4 åœè½¦åœºå†…è½¦è¾†çŠ¶æ€æŸ¥è¯¢åŠŸèƒ½');
  log('åŠŸèƒ½ï¼š1) é€‰æ‹©åœè½¦åœºæŸ¥çœ‹åœ¨åœè½¦è¾† 2) è½¦ç‰Œå·æŸ¥è¯¢');
  log('æµ‹è¯•è½¦ç‰Œå·ï¼šTEST001, TEST002, TEST003, STATUS001, STATUS002, STATUS003');
};

// é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
window.onbeforeunload = function() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
  }
};

// é”®ç›˜äº‹ä»¶ï¼šå›è½¦é”®æŸ¥è¯¢
el('licensePlateQuery').addEventListener('keypress', function(e){
  if(e.key === 'Enter'){
    queryVehicleStatus();
  }
});

</script>
</body>
</html>
