<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åœè½¦åœº2.8.3å‡ºå…¥è®¡è´¹æµ‹è¯•é¡µé¢</title>
  <style>
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      margin: 0;
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      margin: 0 0 10px 0;
      font-size: 2.2em;
    }
    
    .header p {
      margin: 0;
      opacity: 0.9;
    }
    
    .content {
      padding: 30px;
    }
    
    .card { 
      background: #f8f9fa;
      border-radius: 12px; 
      padding: 25px; 
      margin: 20px 0; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border-left: 4px solid #667eea;
    }
    
    .card h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 1.3em;
    }
    
    .row { 
      display: flex; 
      gap: 15px; 
      flex-wrap: wrap; 
    }
    
    .row > * { 
      flex: 1 1 250px; 
    }
    
    label { 
      display: block; 
      font-weight: 600; 
      margin: 8px 0 6px; 
      color: #555;
    }
    
    input, select { 
      width: 100%; 
      padding: 12px 15px; 
      border: 2px solid #e9ecef; 
      border-radius: 8px; 
      font-size: 14px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    button { 
      padding: 12px 20px; 
      border: 0; 
      border-radius: 8px; 
      font-weight: 600; 
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .btn { 
      background: #667eea; 
      color: #fff; 
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn.secondary { 
      background: #6c757d; 
    }
    
    .btn.success { 
      background: #28a745; 
    }
    
    .btn.warning { 
      background: #ffc107; 
      color: #333; 
    }
    
    .btn.danger {
      background: #dc3545;
      color: white;
    }
    
    .log { 
      font-family: 'Consolas', 'Monaco', monospace; 
      white-space: pre-wrap; 
      background: #f8f9fa; 
      border: 1px solid #e9ecef; 
      padding: 15px; 
      border-radius: 8px; 
      max-height: 400px; 
      overflow: auto;
      font-size: 13px;
      line-height: 1.5;
    }
    
    .badge { 
      padding: 4px 12px; 
      border-radius: 20px; 
      font-size: 12px; 
      font-weight: 600;
      display: inline-block;
    }
    
    .badge.ok{ 
      background: #d4edda; 
      color: #155724; 
    }
    
    .badge.err{ 
      background: #f8d7da; 
      color: #721c24; 
    }
    
    .badge.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-bar {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
    }
    
    .table-container {
      margin-top: 15px;
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    th {
      background: #f8f9fa;
      padding: 12px 8px;
      border: 1px solid #e9ecef;
      font-weight: 600;
      text-align: left;
      color: #495057;
    }
    
    td {
      padding: 12px 8px;
      border: 1px solid #e9ecef;
      vertical-align: middle;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      color: #6c757d;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš— åœè½¦åœº2.8.3åŠŸèƒ½æµ‹è¯•</h1>
      <p>è½¦è¾†å‡ºå…¥è®¡è´¹åŠŸèƒ½æµ‹è¯•é¡µé¢</p>
    </div>
    
    <div class="content">
      <!-- é…ç½®é¢æ¿ -->
  <div class="card">
        <h3>âš™ï¸ ç³»ç»Ÿé…ç½®</h3>
    <div class="row">
      <div>
        <label>API åŸºç¡€åœ°å€</label>
        <input id="apiBaseUrl" value="http://localhost:5263/api/Parking" />
      </div>
      <div>
        <label>æ“ä½œå‘˜è´¦å·</label>
        <select id="operatorAccount">
              <option value="admin_test">admin_test (ç®¡ç†å‘˜æµ‹è¯•)</option>
              <option value="manager_test">manager_test (ç»ç†æµ‹è¯•)</option>
              <option value="staff_test">staff_test (å‘˜å·¥æµ‹è¯•)</option>
        </select>
      </div>
    </div>
        <div class="status-bar">
          <button class="btn" onclick="testApi()">ğŸ”— æµ‹è¯•è¿æ¥</button>
          <span id="statusBadge" class="badge warning">æœªæµ‹è¯•</span>
    </div>
  </div>

      <!-- è½¦è¾†å…¥åœº -->
  <div class="card">
        <h3>ğŸš— ä¸€ã€è½¦è¾†å…¥åœº</h3>
    <div class="row">
      <div>
            <label>è½¦ç‰Œå·</label>
        <input id="lpEntry" placeholder="å¦‚ï¼šTEST888" />
      </div>
      <div>
            <label>è½¦ä½ID</label>
            <input id="spaceEntry" type="number" placeholder="å¦‚ï¼š1001" />
      </div>
    </div>
        <div style="margin-top: 15px;">
          <button class="btn success" onclick="vehicleEntry()">âœ… è½¦è¾†å…¥åœº</button>
    </div>
  </div>

      <!-- è½¦è¾†å‡ºåœº -->
  <div class="card">
        <h3>ğŸšª äºŒã€è½¦è¾†å‡ºåœºï¼ˆè®¡ç®—è´¹ç”¨ï¼‰</h3>
    <div class="row">
      <div>
            <label>è½¦ç‰Œå·</label>
        <input id="lpExit" placeholder="ä¸å…¥åœºä¸€è‡´" />
      </div>
    </div>
        <div style="margin-top: 15px;">
          <button class="btn warning" onclick="vehicleExit()">ğŸ’° è®¡ç®—è´¹ç”¨</button>
    </div>
  </div>

      <!-- ç¼´è´¹ç¡®è®¤ -->
  <div class="card">
        <h3>ğŸ’³ ä¸‰ã€ç¼´è´¹ç¡®è®¤</h3>
    <div class="row">
      <div>
        <label>è½¦ç‰Œå·</label>
        <input id="lpPay" placeholder="ä¸å…¥åœºä¸€è‡´" />
      </div>
      <div>
        <label>è½¦ä½ID</label>
            <input id="spacePay" type="number" placeholder="å‡ºåœºç»“æœé‡Œçš„è½¦ä½ID" />
      </div>
      <div>
            <label>åœè½¦å¼€å§‹æ—¶é—´</label>
            <input id="parkStartPay" placeholder="ISOæ—¶é—´æ ¼å¼" />
      </div>
      <div>
            <label>åœè½¦ç»“æŸæ—¶é—´</label>
            <input id="parkEndPay" placeholder="ISOæ—¶é—´æ ¼å¼" />
      </div>
      <div>
            <label>æ€»é‡‘é¢</label>
            <input id="feePay" type="number" step="0.01" placeholder="è´¹ç”¨é‡‘é¢" />
      </div>
      <div>
            <label>æ”¯ä»˜æ–¹å¼</label>
        <select id="methodPay">
          <option>ç°é‡‘</option>
          <option>å¾®ä¿¡æ”¯ä»˜</option>
          <option>æ”¯ä»˜å®</option>
          <option>é“¶è¡Œå¡</option>
          <option>æ— æ„Ÿæ”¯ä»˜</option>
        </select>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <button class="btn" onclick="pay()">ğŸ’³ ç¡®è®¤æ”¯ä»˜</button>
        </div>
      </div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="card">
        <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
        <div class="summary-stats">
          <div class="stat-card">
            <div class="stat-number" id="unpaidCount">0</div>
            <div class="stat-label">æœªæ”¯ä»˜è®°å½•</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="paidCount">0</div>
            <div class="stat-label">å·²æ”¯ä»˜è®°å½•</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalRevenue">Â¥0</div>
            <div class="stat-label">æ€»æ”¶å…¥</div>
          </div>
    </div>
        <div class="action-buttons">
          <button class="btn secondary" onclick="loadUnpaidRecords()">ğŸ”„ åˆ·æ–°æœªæ”¯ä»˜è®°å½•</button>
          <button class="btn secondary" onclick="loadPaidRecords()">ğŸ”„ åˆ·æ–°å·²æ”¯ä»˜è®°å½•</button>
          <button class="btn" onclick="loadAllRecords()">ğŸ”„ åˆ·æ–°æ‰€æœ‰è®°å½•</button>
    </div>
  </div>

      <!-- æœªæ”¯ä»˜è®°å½• -->
  <div class="card">
        <h3>â³ æœªæ”¯ä»˜è®°å½•</h3>
        <div id="unpaidRecords" class="table-container"></div>
  </div>

      <!-- å·²æ”¯ä»˜è®°å½• -->
  <div class="card">
        <h3>âœ… å·²æ”¯ä»˜è®°å½•</h3>
        <div id="paidRecords" class="table-container"></div>
  </div>

      <!-- è°ƒè¯•è¾“å‡º -->
  <div class="card">
        <h3>ğŸ” è°ƒè¯•è¾“å‡º</h3>
    <div id="log" class="log"></div>
        <div style="margin-top: 10px;">
          <button class="btn secondary btn-small" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
      </div>
    </div>
  </div>

<script>
const el = id => document.getElementById(id);
const api = () => (el('apiBaseUrl').value.trim() || 'http://localhost:5263/api/Parking');
const operator = () => el('operatorAccount').value.trim();

const log = (...args) => { 
  console.log(...args); 
  const box = el('log'); 
  const timestamp = new Date().toLocaleTimeString();
  const message = args.map(a => typeof a === 'string' ? a : JSON.stringify(a, null, 2)).join(' ');
  box.textContent = `[${timestamp}] ${message}\n` + box.textContent;
  box.scrollTop = 0;
};

const setBadge = (ok, msg) => { 
  const b = el('statusBadge'); 
  b.textContent = msg; 
  b.className = 'badge ' + (ok ? 'ok' : 'err'); 
};

const clearLog = () => {
  el('log').textContent = '';
};

async function testApi(){
  const url = api() + '/spaces?areaId=1001';
  try{ 
    const r = await fetch(url); 
    setBadge(r.ok, 'è¿æ¥' + (r.ok ? 'æ­£å¸¸' : 'å¼‚å¸¸')); 
    const j = await r.json().catch(() => ({raw: 'éJSON'})); 
    log('æµ‹è¯•è¿æ¥', url, r.status, r.statusText, j); 
  }
  catch(e){ 
    setBadge(false, 'è¿æ¥å¼‚å¸¸'); 
    log('æµ‹è¯•è¿æ¥å¼‚å¸¸', url, e.name, e.message); 
  }
}

async function vehicleEntry(){
  const url = api() + '/Entry';
  const body = {
    LicensePlateNumber: el('lpEntry').value.trim(),
    ParkingSpaceId: Number(el('spaceEntry').value),
    OperatorAccount: operator()
  };
  
  if (!body.LicensePlateNumber || !body.ParkingSpaceId || !body.OperatorAccount) {
    log('âŒ è¯·å¡«å†™å®Œæ•´çš„å…¥åœºä¿¡æ¯');
    return;
  }
  
  try{
    const resp = await fetch(url, { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify(body) 
    });
    const data = await resp.json().catch(() => ({raw: 'éJSON'}));
    log('Entry è¯·æ±‚', url, body); 
    log('Entry å“åº”', resp.status, resp.statusText, data);
    
    if (resp.ok && data.Success) {
      log('âœ… è½¦è¾†å…¥åœºæˆåŠŸ');
      // è‡ªåŠ¨å¡«å……å‡ºåœºä¿¡æ¯
      el('lpExit').value = body.LicensePlateNumber;
    }
  }catch(e){ 
    log('Entry å¼‚å¸¸', e.name, e.message); 
  }
}

async function vehicleExit(){
  const url = api() + '/Exit';
  const body = {
    LicensePlateNumber: el('lpExit').value.trim(),
    OperatorAccount: operator()
  };
  
  if (!body.LicensePlateNumber || !body.OperatorAccount) {
    log('âŒ è¯·å¡«å†™å®Œæ•´çš„å‡ºåœºä¿¡æ¯');
    return;
  }
  
  try{
    const resp = await fetch(url, { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify(body) 
    });
    const data = await resp.json().catch(() => ({raw: 'éJSON'}));
    log('Exit è¯·æ±‚', url, body); 
    log('Exit å“åº”', resp.status, resp.statusText, data);
    
    // è‡ªåŠ¨å¡«å……æ”¯ä»˜ä¿¡æ¯
    if(resp.ok && data && data.Data){
      const r = data.Data;
      el('lpPay').value = r.LicensePlateNumber;
      el('spacePay').value = r.ParkingSpaceId;
      el('parkStartPay').value = new Date(r.ParkStart).toISOString();
      el('parkEndPay').value = new Date(r.ParkEnd).toISOString();
      el('feePay').value = r.TotalFee;
      log('âœ… è´¹ç”¨è®¡ç®—å®Œæˆï¼Œå·²è‡ªåŠ¨å¡«å……æ”¯ä»˜ä¿¡æ¯');
    }
  }catch(e){ 
    log('Exit å¼‚å¸¸', e.name, e.message); 
    }
}

async function pay(){
  const base = api();
  const op = operator();
  const url = `${base}/Pay?operatorAccount=${encodeURIComponent(op)}`;
  const body = {
    LicensePlateNumber: el('lpPay').value.trim(),
    ParkingSpaceId: Number(el('spacePay').value),
    ParkStart: new Date(el('parkStartPay').value),
    ParkEnd: new Date(el('parkEndPay').value),
    TotalFee: Number(el('feePay').value),
    PaymentMethod: el('methodPay').value
  };
  
  if (!body.LicensePlateNumber || !body.ParkingSpaceId || !body.TotalFee) {
    log('âŒ è¯·å¡«å†™å®Œæ•´çš„æ”¯ä»˜ä¿¡æ¯');
    return;
  }
  
  try{
    const resp = await fetch(url, { 
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      body: JSON.stringify(body) 
    });
    const data = await resp.json().catch(() => ({raw: 'éJSON'}));
    log('Pay è¯·æ±‚', url, body); 
    log('Pay å“åº”', resp.status, resp.statusText, data);
    
    // æ”¯ä»˜æˆåŠŸååˆ·æ–°è®°å½•
    if(resp.ok && data && data.Success){
      log('âœ… æ”¯ä»˜æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°è®°å½•...');
      setTimeout(() => {
        loadAllRecords();
      }, 500);
    }
  }catch(e){ 
    log('Pay å¼‚å¸¸', e.name, e.message); 
  }
}

// åŠ è½½æ‰€æœ‰æœªæ”¯ä»˜è®°å½•
async function loadUnpaidRecords(){
  const url = api() + '/PaymentRecords?status=unpaid';
  try{
    const resp = await fetch(url);
    const data = await resp.json();
    log('UnpaidRecords è¯·æ±‚', url);
    log('UnpaidRecords å“åº”', resp.status, resp.statusText, data);
    
    if(resp.ok && data && data.Data){
      displayUnpaidRecords(data.Data);
      updateStats();
    }
  }catch(e){ 
    log('UnpaidRecords å¼‚å¸¸', e.name, e.message); 
    }
}

// åŠ è½½æ‰€æœ‰å·²æ”¯ä»˜è®°å½•
async function loadPaidRecords(){
  const url = api() + '/PaymentRecords?status=paid';
  try{
    const resp = await fetch(url);
    const data = await resp.json();
    log('PaidRecords è¯·æ±‚', url);
    log('PaidRecords å“åº”', resp.status, resp.statusText, data);
    
    if(resp.ok && data && data.Data){
      displayPaidRecords(data.Data);
      updateStats();
    }
  }catch(e){ 
    log('PaidRecords å¼‚å¸¸', e.name, e.message); 
  }
}

// åŠ è½½æ‰€æœ‰è®°å½•
async function loadAllRecords() {
  await Promise.all([loadUnpaidRecords(), loadPaidRecords()]);
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats() {
  const unpaidContainer = el('unpaidRecords');
  const paidContainer = el('paidRecords');
  
  const unpaidCount = unpaidContainer.querySelectorAll('tr').length - 1; // å‡å»è¡¨å¤´
  const paidCount = paidContainer.querySelectorAll('tr').length - 1;
  
  el('unpaidCount').textContent = Math.max(0, unpaidCount);
  el('paidCount').textContent = Math.max(0, paidCount);
  
  // è®¡ç®—æ€»æ”¶å…¥
  let totalRevenue = 0;
  const paidRows = paidContainer.querySelectorAll('tr');
  paidRows.forEach((row, index) => {
    if (index > 0) { // è·³è¿‡è¡¨å¤´
      const feeCell = row.querySelector('td:nth-child(6)');
      if (feeCell) {
        const feeText = feeCell.textContent.replace('Â¥', '');
        totalRevenue += parseFloat(feeText) || 0;
      }
    }
  });
  
  el('totalRevenue').textContent = `Â¥${totalRevenue.toFixed(2)}`;
}

// æ˜¾ç¤ºæœªæ”¯ä»˜è®°å½•
function displayUnpaidRecords(records){
  const container = el('unpaidRecords');
  if(records.length === 0){
    container.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">æš‚æ— æœªæ”¯ä»˜è®°å½•</p>';
    return;
  }
  
  let html = '<table>';
  html += '<tr><th>è½¦ç‰Œå·</th><th>è½¦ä½</th><th>å…¥åœºæ—¶é—´</th><th>å‡ºåœºæ—¶é—´</th><th>åœè½¦æ—¶é•¿</th><th>è´¹ç”¨</th><th>æ“ä½œ</th></tr>';
  
  records.forEach(record => {
    const parkStart = new Date(record.ParkStart).toLocaleString('zh-CN');
    const parkEnd = new Date(record.ParkEnd).toLocaleString('zh-CN');
    const duration = formatDuration(record.ParkingDuration);
    
    html += `<tr>
      <td>${record.LicensePlateNumber}</td>
      <td>${record.ParkingSpaceId}</td>
      <td>${parkStart}</td>
      <td>${parkEnd}</td>
      <td>${duration}</td>
      <td>Â¥${record.TotalFee}</td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-small" onclick="fillPaymentForm('${record.LicensePlateNumber}', ${record.ParkingSpaceId}, '${record.ParkStart}', '${record.ParkEnd}', ${record.TotalFee})">å¡«å…¥è¡¨å•</button>
        </div>
      </td>
    </tr>`;
  });
  
  html += '</table>';
  container.innerHTML = html;
}

// æ˜¾ç¤ºå·²æ”¯ä»˜è®°å½•
function displayPaidRecords(records){
  const container = el('paidRecords');
  if(records.length === 0){
    container.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">æš‚æ— å·²æ”¯ä»˜è®°å½•</p>';
    return;
  }
  
  let html = '<table>';
  html += '<tr><th>è½¦ç‰Œå·</th><th>è½¦ä½</th><th>å…¥åœºæ—¶é—´</th><th>å‡ºåœºæ—¶é—´</th><th>åœè½¦æ—¶é•¿</th><th>è´¹ç”¨</th><th>çŠ¶æ€</th></tr>';
  
  records.forEach(record => {
    const parkStart = new Date(record.ParkStart).toLocaleString('zh-CN');
    const parkEnd = new Date(record.ParkEnd).toLocaleString('zh-CN');
    const duration = formatDuration(record.ParkingDuration);
    
    html += `<tr>
      <td>${record.LicensePlateNumber}</td>
      <td>${record.ParkingSpaceId}</td>
      <td>${parkStart}</td>
      <td>${parkEnd}</td>
      <td>${duration}</td>
      <td>Â¥${record.TotalFee}</td>
      <td><span class="badge ok">å·²æ”¯ä»˜</span></td>
    </tr>`;
  });
  
  html += '</table>';
  container.innerHTML = html;
}

// æ ¼å¼åŒ–åœè½¦æ—¶é•¿
function formatDuration(duration){
  const match = duration.match(/(\d+):(\d+):(\d+)/);
  if(match){
    const hours = parseInt(match[1]);
    const minutes = parseInt(match[2]);
    return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
  }
  return duration;
}

// å¡«å…¥æ”¯ä»˜è¡¨å•
function fillPaymentForm(licensePlate, spaceId, parkStart, parkEnd, totalFee){
  el('lpPay').value = licensePlate;
  el('spacePay').value = spaceId;
  el('parkStartPay').value = new Date(parkStart).toISOString();
  el('parkEndPay').value = new Date(parkEnd).toISOString();
  el('feePay').value = totalFee;
  log('âœ… å·²å¡«å…¥æ”¯ä»˜è¡¨å•', licensePlate, spaceId);
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ‰€æœ‰è®°å½•
window.onload = function(){
  log('ğŸš€ 2.8.3æµ‹è¯•é¡µé¢å·²åŠ è½½');
  loadAllRecords();
};
</script>
</body>
</html>

